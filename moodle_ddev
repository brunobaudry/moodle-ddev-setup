#!/bin/bash

# -------------------------------
# ‚úÖ Environment Checks
# -------------------------------
check_environment() {
  if ! command -v docker > /dev/null; then
    echo "‚ùå Docker is not running or not installed."
    exit 1
  fi

  if ! docker info > /dev/null 2>&1; then
    echo "‚ùå Docker daemon is not running. Please start Docker."
    exit 1
  fi

  if ! command -v ddev > /dev/null; then
    echo "‚ùå DDEV is not installed. Please install DDEV."
    exit 1
  fi

  if ! command -v composer > /dev/null; then
    echo "‚ùå Composer is not installed. Please install Composer."
    exit 1
  fi

  if ! command -v jq > /dev/null; then
    echo "‚ùå jq is not installed. Please install jq (used to parse DDEV output)."
    exit 1
  fi
  echo "‚úÖ All tools are available"
}

# -------------------------------
# ‚úÖ Validation Functions
# -------------------------------
validate_php_version() {
  case "$1" in
    8.2|8.3|8.4) return 0 ;;
    *) return 1 ;;
  esac
}

validate_moodle_version() {
  local version="$1"

  if [[ "$version" =~ ^(401|402|403|404|405|500|501)$ ]]; then
    return 0
  elif [[ "$version" =~ ^(4\.[0-5]\.[0-9]+|5\.0\.[0-9]+|5\.1\.[0-9]+)$ ]]; then
    return 0
  else
    return 1
  fi
}

get_moodle_package() {
  local version="$1"
  if [[ -z "$version" ]]; then
    echo "moodle/moodle"
  elif [[ "$version" =~ ^(4|5)[0-9]{2}$ ]]; then
    echo "moodle/moodle:dev-MOODLE_${version}_STABLE"
  elif [[ "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "moodle/moodle:${version}"
  else
    return 1
  fi
}

is_moodle_version_5_1_or_higher() {
  local version="$1"
  if [[ "$version" =~ ^[0-9]{3}$ ]]; then
    local major="${version:0:1}"
    local minor="${version:1:2}"
    (( major > 5 || (major == 5 && minor >= 1) )) && return 0
  elif [[ "$version" =~ ^([0-9]+)\.([0-9]+)(\.[0-9]+)?$ ]]; then
    local major="${BASH_REMATCH[1]}"
    local minor="${BASH_REMATCH[2]}"
    (( major > 5 || (major == 5 && minor >= 1) )) && return 0
  fi
  return 1
}

cleanup_failed_install() {
  echo "üßπ Cleaning up failed install..."
  ddev delete --omit-snapshot
  rm -rf moodle moodledata .ddev
  docker builder prune
}

# -------------------------------
# ‚úÖ Argument Parsing
# -------------------------------
php_version=""
moodle_version=""
force=false
root_folder="."  # You can change this to any desired root path
while [[ $# -gt 0 ]]; do
  case "$1" in
    --php)
      php_version="$2"
      shift 2
      ;;
    --version)
      moodle_version="$2"
      shift 2
      ;;
    --force)
      force=true
      shift
      ;;
    --root)
      root_folder="$2"
      shift 2
      ;;
    *)
      echo "‚ùå Unknown option: $1"
      echo "Usage: $0 --php <version> --version <moodle_version> [--force] [--root <folder>]"
      exit 1
      ;;
  esac
done

# Build full project path
project_dir="${root_folder}/moodle${moodle_version}"


# -------------------------------
# ‚úÖ Start Script
# -------------------------------
check_environment


# Interactive fallback
if [[ -z "$php_version" ]]; then
  read -p "Enter PHP version (8.2, 8.3, 8.4): " php_version
fi

if [[ -z "$moodle_version" ]]; then
  read -p "Enter Moodle version (e.g. 401 or 5.1.0): " moodle_version
fi

# validates
if ! validate_php_version "$php_version"; then
  echo "‚ùå Invalid PHP version. Allowed: 8.2, 8.3, 8.4."
  exit 1
fi

if ! validate_moodle_version "$moodle_version"; then
  echo "‚ùå Invalid Moodle version. Allowed: 401‚Äì501 or 4.x.x/5.x.x."
  exit 1
fi

project_dir="moodle${moodle_version}"
if [[ -d "$project_dir" && "$force" != true ]]; then
  echo "‚ö†Ô∏è Directory '$project_dir' already exists. Use --force to overwrite."
  exit 1
fi

rm -rf "$project_dir"
mkdir "$project_dir"
cd "$project_dir" || exit
mkdir moodle
mkdir -p moodledata
chmod -R 777 moodledata

# -------------------------------
# ‚úÖ DDEV Config
# -------------------------------
if is_moodle_version_5_1_or_higher "$moodle_version"; then
  ddev config --composer-root='./moodle' --docroot='./moodle/public' --webserver-type=apache-fpm
else
  ddev config --composer-root='./moodle' --docroot='./moodle' --webserver-type=apache-fpm
fi

# Update PHP version in config
sed -i "s/php_version:.*/php_version: $php_version/" .ddev/config.yaml
# Start DDEV
ddev start

# -------------------------------
# ‚úÖ Composer Install
# -------------------------------
moodle_package=$(get_moodle_package "$moodle_version")

if ! ddev composer create-project "$moodle_package"; then
  echo "‚ùå Composer project creation failed. Version may not exist."
  cleanup_failed_install
  exit 1
fi

# -------------------------------
# ‚úÖ Moodle CLI Install
# -------------------------------
wwwroot=$(ddev describe -j | jq -r '.raw.primary_url')

if ! ddev exec php ./moodle/admin/cli/install.php \
  --non-interactive \
  --agree-license \
  --wwwroot="$wwwroot" \
  --dbtype=mariadb \
  --dbhost=db \
  --dbname=db \
  --dbuser=db \
  --dbpass=db \
  --fullname="DDEV Moodle $moodle_version" \
  --shortname="DDEV$moodle_version" \
  --adminpass=1234; then
  echo "‚ùå Moodle CLI installation failed."
  cleanup_failed_install
  exit 1
fi

# -------------------------------
# ‚úÖ Success Message
# -------------------------------
echo ""
echo "‚úÖ Moodle $moodle_version with PHP $php_version setup completed using DDEV."
echo "üîó Admin site: $wwwroot"
echo "üîê Admin password: 1234"
